name: E2E Test Harness
on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly Monday 6am UTC
  workflow_dispatch:
    inputs:
      project:
        description: 'Specific project to test (leave empty for all)'
        required: false
        type: string
      ai_eval:
        description: 'Run AI evaluation'
        required: false
        type: boolean
        default: false

jobs:
  build-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Build server JAR
        run: server/gradlew -p server shadowJar
      - uses: actions/upload-artifact@v4
        with:
          name: server-jar
          path: server/build/libs/server-all.jar

  test-harness:
    needs: build-server
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: [NotyKT, kotlinx-coroutines, compose-samples, ktor]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: actions/download-artifact@v4
        with:
          name: server-jar
          path: server/build/libs/
      - name: Install harness dependencies
        run: cd test-harness && npm install
      - name: Build harness
        run: cd test-harness && npm run build
      - name: Run test harness
        run: |
          cd test-harness
          PROJECT_FLAG=""
          if [ -n "${{ inputs.project }}" ]; then
            PROJECT_FLAG="--project ${{ inputs.project }}"
          else
            PROJECT_FLAG="--project ${{ matrix.project }}"
          fi
          AI_FLAG=""
          if [ "${{ inputs.ai_eval }}" = "true" ]; then
            AI_FLAG="--ai-eval"
          fi
          node dist/cli.js run $PROJECT_FLAG --compare-baseline --format both $AI_FLAG
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: harness-report-${{ matrix.project }}
          path: test-harness/reports/

  summary:
    needs: test-harness
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: harness-report-*
          path: all-reports/
          merge-multiple: true
      - name: Print summary
        run: |
          echo "## E2E Test Harness Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for f in all-reports/*.json; do
            if [ -f "$f" ]; then
              echo "### $(basename "$f" .json)" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              cat "$f" | python3 -c "import sys,json; d=json.load(sys.stdin); print(json.dumps(d.get('summary',{}), indent=2))" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          done
